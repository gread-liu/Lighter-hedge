# 账户清空工具使用说明

## 功能说明

[`clear_accounts.py`](clear_accounts.py) 是一个一键清空A、B两个账户的工具程序，可以：

1. **取消所有活跃订单** - 清空账户中所有未成交的限价单
2. **平掉所有持仓** - 使用市价单平掉账户中的所有多头或空头仓位
3. **支持单独或批量操作** - 可以选择清空单个账户或同时清空两个账户

## 使用方法

### 基本用法

```bash
# 清空所有账户（A和B）
cd hedge_strategy
python3 clear_accounts.py

# 或指定清空所有账户
python3 clear_accounts.py --account all
```

### 清空单个账户

```bash
# 只清空A账户
python3 clear_accounts.py --account a

# 只清空B账户
python3 clear_accounts.py --account b
```

### 指定市场

```bash
# 清空指定市场的订单和持仓（默认BTC）
python3 clear_accounts.py --market BTC

# 清空ETH市场
python3 clear_accounts.py --market ETH
```

### 组合使用

```bash
# 只清空A账户的ETH市场
python3 clear_accounts.py --account a --market ETH
```

## 参数说明

| 参数 | 可选值 | 默认值 | 说明 |
|------|--------|--------|------|
| `--account` | `a`, `b`, `all` | `all` | 要清空的账户 |
| `--market` | 市场符号 | `BTC` | 要清空的市场 |

## 执行流程

### 1. 清空单个账户流程

```
初始化客户端
    ↓
获取市场信息
    ↓
查询活跃订单
    ↓
逐个取消订单
    ↓
查询持仓情况
    ↓
判断持仓方向
    ↓
创建市价单平仓
    ↓
验证平仓结果
```

### 2. 清空所有账户流程

```
清空A账户
    ↓
等待1秒
    ↓
清空B账户
    ↓
输出汇总结果
```

## 输出示例

### 成功清空示例

```
############################################################
# 开始清空account_a账户
############################################################
✅ account_a账户客户端初始化成功

============================================================
开始取消account_a账户的所有活跃订单...
============================================================
📋 找到 3 个活跃订单
✅ 已取消订单: 844424550066612
✅ 已取消订单: 562950327154264
✅ 已取消订单: 562950327149650

✅ account_a账户订单取消完成: 3/3

============================================================
开始平掉account_a账户的所有持仓...
============================================================
📊 当前持仓: 0.0002
📍 持仓类型: 多头, 需要卖出平仓
💰 平仓价格: 109391.6, 数量: 0.0002
✅ 平仓订单创建成功
📝 交易哈希: 237d45de6973bf9f...
✅ account_a账户持仓已成功平掉

============================================================
✅ account_a账户清空完成！
   - 取消订单: 3 个
   - 平仓状态: 成功
============================================================
```

### 无订单和持仓示例

```
============================================================
开始取消account_b账户的所有活跃订单...
============================================================
✅ account_b账户没有活跃订单

============================================================
开始平掉account_b账户的所有持仓...
============================================================
✅ account_b账户没有持仓

============================================================
✅ account_b账户清空完成！
   - 取消订单: 0 个
   - 平仓状态: 成功
============================================================
```

### 汇总结果示例

```
############################################################
# 清空结果汇总
############################################################
A账户: ✅ 成功
B账户: ✅ 成功
############################################################
```

## 注意事项

### ⚠️ 重要提醒

1. **不可逆操作** - 清空操作会立即执行，无法撤销
2. **市价平仓** - 平仓使用市价单，可能有滑点
3. **网络延迟** - 执行过程中请保持网络连接稳定
4. **余额要求** - 确保账户有足够的gas费用

### 🔒 安全建议

1. **先停止策略** - 清空前建议先停止A、B入口程序
2. **确认账户** - 执行前确认要清空的账户
3. **检查结果** - 执行后检查日志确认清空成功
4. **备份配置** - 重要配置文件建议备份

## 停止策略后清空

### 推荐流程

```bash
# 1. 停止A和B入口
cd hedge_strategy
./stop_hedge.sh

# 2. 等待进程完全停止
sleep 2

# 3. 清空所有账户
python3 clear_accounts.py

# 4. 查看清空结果
# 检查日志输出确认清空成功
```

## 常见问题

### Q1: 清空失败怎么办？

**A:** 检查以下几点：
- 网络连接是否正常
- API密钥是否有效
- 账户余额是否充足
- 查看错误日志定位问题

### Q2: 部分订单取消失败？

**A:** 可能原因：
- 订单已经成交
- 订单已过期
- 网络超时

建议重新运行清空程序。

### Q3: 持仓未完全平掉？

**A:** 可能原因：
- 市场流动性不足
- 价格波动过大
- 订单部分成交

建议：
1. 查看日志中的剩余持仓
2. 手动平掉剩余仓位
3. 或再次运行清空程序

### Q4: 可以在策略运行时清空吗？

**A:** 不建议。原因：
- 策略可能继续创建新订单
- 可能导致账户状态不一致
- 建议先停止策略再清空

## 技术细节

### 平仓逻辑

```python
# 多头持仓 → 卖出平仓
if position_size > 0:
    is_ask = True  # 卖出
    
# 空头持仓 → 买入平仓
else:
    is_ask = False  # 买入
    position_size = abs(position_size)
```

### 市价单参数

```python
await client.create_market_order(
    market_index=market_index,
    client_order_index=0,
    base_amount=base_amount,
    avg_execution_price=avg_execution_price,
    is_ask=is_ask,
    reduce_only=True  # 只减仓，不开新仓
)
```

## 相关文件

- [`clear_accounts.py`](clear_accounts.py) - 清空工具主程序
- [`config.yaml`](config.yaml) - 账户配置文件
- [`stop_hedge.sh`](stop_hedge.sh) - 停止策略脚本

## 日志级别

程序使用INFO级别日志，输出包括：
- ✅ 成功操作
- ❌ 失败操作
- ⚠️ 警告信息
- 📋 统计信息
- 📍 状态信息
- 💰 价格信息

## 示例脚本

### 完整清空流程

```bash
#!/bin/bash
# 完整清空A、B账户的脚本

echo "=== 开始清空账户流程 ==="

# 1. 停止策略
echo "1. 停止A和B入口..."
cd hedge_strategy
./stop_hedge.sh
sleep 3

# 2. 清空账户
echo "2. 清空所有账户..."
python3 clear_accounts.py --account all --market BTC

# 3. 验证结果
echo "3. 清空完成！"
echo "请检查上方日志确认清空成功"
```

## 更新日志

- **v1.0.0** (2025-10-23)
  - 初始版本
  - 支持取消订单和平仓
  - 支持单独或批量清空账户

---

**最后更新**: 2025-10-23
**版本**: v1.0.0