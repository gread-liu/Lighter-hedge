# 一键清空账户指南

## 功能说明

清空程序可以快速清理A、B两个账户的所有订单和持仓，支持：
- ✅ 取消所有活跃订单
- ✅ 使用市价单平掉所有持仓
- ✅ 支持单独清空或同时清空两个账户
- ✅ 支持指定不同的市场（ETH、BTC、ENA等）

## 使用方法

### 方式1：使用快速清空脚本（推荐）

清空ETH市场的所有账户：
```bash
cd hedge_strategy
./quick_clear_eth.sh
```

### 方式2：使用Python命令

#### 清空所有账户（默认BTC市场）
```bash
cd hedge_strategy
python3 clear_accounts.py
```

#### 清空所有账户（指定市场）
```bash
cd hedge_strategy
python3 clear_accounts.py --market ETH
python3 clear_accounts.py --market BTC
python3 clear_accounts.py --market ENA
```

#### 只清空A账户
```bash
cd hedge_strategy
python3 clear_accounts.py --account a --market ETH
```

#### 只清空B账户
```bash
cd hedge_strategy
python3 clear_accounts.py --account b --market ETH
```

## 参数说明

- `--account`: 要清空的账户
  - `a`: 只清空A账户
  - `b`: 只清空B账户
  - `all`: 清空所有账户（默认）

- `--market`: 市场符号
  - `ETH`: 以太坊市场（默认）
  - `BTC`: 比特币市场
  - `ENA`: ENA市场
  - 其他支持的市场

## 执行流程

1. **初始化客户端**
   - 加载配置文件
   - 连接到Lighter交易所

2. **取消活跃订单**
   - 查询所有活跃订单
   - 逐个取消订单

3. **平掉持仓**
   - 查询当前持仓
   - 判断持仓方向（多头/空头）
   - 使用市价单平仓
   - 验证持仓是否已清空

## 平仓逻辑

### 持仓方向判断
在Lighter交易所中：
- **正数持仓** = 空头持仓 → 需要**买入**平仓（is_ask=False）
- **负数持仓** = 多头持仓 → 需要**卖出**平仓（is_ask=True）

### 市价单策略
为确保快速成交，使用激进的价格策略：
- **平空头（买入）**：使用卖5档价格（更高的价格，确保能买到）
- **平多头（卖出）**：使用买5档价格（更低的价格，确保能卖出）

### 重试机制
- 最多重试3次
- 每次重试前会重新查询持仓
- 如果持仓已清空，立即返回成功

## 注意事项

⚠️ **重要提醒**：
1. 清空程序会**立即取消所有订单**并**平掉所有持仓**
2. 使用市价单平仓，可能会有一定的滑点
3. 执行前请确认要清空的市场是否正确
4. 建议在停止对冲策略后再执行清空操作

## 示例输出

```
==========================================
开始清空ETH市场的A和B账户
==========================================

############################################################
# 开始清空account_a账户
############################################################
✅ account_a账户客户端初始化成功
📍 市场: ETH, 索引: 0

============================================================
开始取消account_a账户的所有活跃订单...
============================================================
✅ account_a账户没有活跃订单

============================================================
开始平掉account_a账户的所有持仓...
============================================================
✅ account_a账户没有持仓

============================================================
✅ account_a账户清空完成！
   - 取消订单: 0 个
   - 平仓状态: 成功
============================================================

############################################################
# 开始清空account_b账户
############################################################
✅ account_b账户客户端初始化成功
📍 市场: ETH, 索引: 0

============================================================
开始取消account_b账户的所有活跃订单...
============================================================
✅ account_b账户没有活跃订单

============================================================
开始平掉account_b账户的所有持仓...
============================================================
📊 当前持仓: 0.0027
📍 持仓类型: 空头, 需要买入平仓 (is_ask=False)
💰 平仓价格: 3870.67, 数量: 0.0027
✅ 市价平仓单创建成功
📝 交易哈希: 2df3e415803217ce5195ac5e55e2de1b7a29c09bccc1bb083c338e77e2875ab649cf73e5e7679e42
✅ account_b账户持仓已成功平掉

============================================================
✅ account_b账户清空完成！
   - 取消订单: 0 个
   - 平仓状态: 成功
============================================================

############################################################
# 清空结果汇总
############################################################
A账户: ✅ 成功
B账户: ✅ 成功
############################################################

==========================================
清空完成！
==========================================
```

## 故障排查

### 问题1：清空失败
**可能原因**：
- 网络连接问题
- API密钥配置错误
- 市场索引不正确

**解决方法**：
1. 检查网络连接
2. 验证config.yaml中的API配置
3. 确认市场名称是否正确

### 问题2：持仓未完全平掉
**可能原因**：
- 市价单未完全成交
- 订单上链延迟

**解决方法**：
1. 等待几秒后重新执行清空程序
2. 检查交易所网站确认持仓状态
3. 如果持仓很小，可能是精度问题，可以忽略

### 问题3：市场不匹配
**症状**：清空程序显示成功，但实际账户未清空

**原因**：清空程序使用的市场与对冲策略使用的市场不一致

**解决方法**：
- 确认对冲策略启动时使用的`--market`参数
- 使用相同的市场参数执行清空程序
- 例如：如果对冲策略使用`--market ETH`，清空时也要使用`--market ETH`

## 相关文件

- [`clear_accounts.py`](clear_accounts.py) - 清空程序主文件
- [`quick_clear_eth.sh`](quick_clear_eth.sh) - ETH市场快速清空脚本
- [`config.yaml`](config.yaml) - 配置文件
- [`utils.py`](utils.py) - 工具函数