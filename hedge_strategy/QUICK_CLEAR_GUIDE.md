# 一键清空账户使用指南

## 概述

`quick_clear_all.py` 是一个用于快速清空所有账户持仓和订单的工具。它会：
1. 取消所有活跃订单
2. 使用市价单平掉所有持仓

## 重要修复说明

### 持仓方向判断修复

在之前的版本中，所有涉及持仓方向判断的代码都存在严重错误：
- **错误做法**：使用 `position` 字段的正负判断多空方向
- **正确做法**：使用 `sign` 字段判断多空方向

#### Lighter交易所持仓表示规则

根据API返回数据：
```json
{
  "position": "0.00060",  // 持仓大小（绝对值，始终为正数）
  "sign": -1              // 持仓方向（1=多头，-1=空头）
}
```

- `sign = 1` → **多头持仓** → 需要**卖出平仓**（`is_ask=True`）
- `sign = -1` → **空头持仓** → 需要**买入平仓**（`is_ask=False`）
- `position` → 持仓大小（绝对值），**不用于判断方向**

#### 已修复的文件

1. **utils.py** - `get_positions()` 函数
   - 修改前：只返回 `position_size`
   - 修改后：返回 `(position_size, sign)` 元组

2. **clear_accounts.py** - 平仓逻辑
   - 修改前：使用 `position_size > 0` 判断空头
   - 修改后：使用 `sign == -1` 判断空头

3. **check_b_position.py** - 持仓查询显示
   - 修改前：根据position正负显示方向
   - 修改后：根据sign字段显示方向

4. **quick_clear_all.py** - 新创建的一键清空工具
   - 直接使用正确的sign判断逻辑

## 使用方法

### 方法1：使用Shell脚本（推荐）

```bash
cd hedge_strategy
./quick_clear_all.sh
```

脚本会提示确认，输入 `y` 后执行清空操作。

### 方法2：直接运行Python脚本

```bash
cd hedge_strategy
python3 quick_clear_all.py
```

## 执行流程

### A账户清空流程
1. **BTC市场**
   - 取消所有活跃订单
   - 查询持仓，如有持仓则使用市价单平仓
2. **ETH市场**
   - 取消所有活跃订单
   - 查询持仓，如有持仓则使用市价单平仓

### B账户清空流程
1. **BTC市场**
   - 取消所有活跃订单
   - 查询持仓，如有持仓则使用市价单平仓
2. **ETH市场**
   - 取消所有活跃订单
   - 查询持仓，如有持仓则使用市价单平仓

## 市价单平仓逻辑

```python
# 查询持仓
position_size, sign = await get_positions(api_client, account_index, market_index)

# 判断平仓方向
if sign == 1:
    # 多头持仓，需要卖出平仓
    is_ask = True
    side_name = "多头"
    action = "卖出平仓"
elif sign == -1:
    # 空头持仓，需要买入平仓
    is_ask = False
    side_name = "空头"
    action = "买入平仓"

# 创建市价单
await client.create_order(
    market_index=market_index,
    base_amount=base_amount,
    price=avg_execution_price,
    is_ask=is_ask,
    order_type=1  # 市价单
)
```

## 注意事项

### 1. 市价单滑点风险
- 市价单可能因滑点过大被取消
- 如果市价单被取消，需要手动处理剩余持仓

### 2. 执行前确认
- 脚本会显示警告信息
- 需要手动输入 `y` 确认执行
- 建议在执行前先查询持仓状态

### 3. 网络延迟
- 订单创建后会等待5秒让订单上链
- 如果网络延迟较大，可能需要更长时间

### 4. 错误处理
- 如果某个市场清空失败，会继续处理其他市场
- 所有错误都会记录在日志中

## 查询持仓状态

在执行清空操作前，建议先查询持仓状态：

```bash
# 查询B账户持仓
cd hedge_strategy
python3 check_b_position.py

# 查询B账户持仓（显示原始API数据）
python3 check_b_position_raw.py
```

## 日志输出示例

```
================================================================================
一键清空所有账户
================================================================================

================================================================================
开始清空 A 账户
================================================================================

--- BTC市场 (market_index=1) ---
INFO:📋 A账户有 2 个活跃订单，开始取消...
INFO:✅ 已取消订单: 562950334350752
INFO:✅ 已取消订单: 562950334353938
INFO:📊 A持仓: 0.00020, 方向: 多头, 操作: 卖出平仓
INFO:🔄 创建市价卖单: amount=20, ref_price=110576.6
INFO:✅ 市价单创建成功: tx_hash=...
INFO:✅ 市价单已成交: filled_amount=0.00020

--- ETH市场 (market_index=0) ---
INFO:✅ A账户没有活跃订单
INFO:✅ A账户没有持仓

✅ A 账户清空完成

================================================================================
开始清空 B 账户
================================================================================

--- BTC市场 (market_index=1) ---
INFO:✅ B账户没有活跃订单
INFO:📊 B持仓: 0.00060, 方向: 空头, 操作: 买入平仓
INFO:🔄 创建市价买单: amount=60, ref_price=110580.4
INFO:✅ 市价单创建成功: tx_hash=...
INFO:✅ 市价单已成交: filled_amount=0.00060

--- ETH市场 (market_index=0) ---
INFO:✅ B账户没有活跃订单
INFO:📊 B持仓: 0.0004, 方向: 多头, 操作: 卖出平仓
INFO:🔄 创建市价卖单: amount=400, ref_price=3456.7
INFO:✅ 市价单创建成功: tx_hash=...
INFO:✅ 市价单已成交: filled_amount=0.0004

✅ B 账户清空完成

================================================================================
✅ 所有账户清空完成！
================================================================================
```

## 故障排查

### 问题1：市价单被取消（canceled-too-much-slippage）

**原因**：市场流动性不足，滑点超过限制

**解决方案**：
1. 等待市场流动性改善
2. 手动使用限价单平仓
3. 分批平仓，减少单次平仓数量

### 问题2：订单创建失败

**原因**：API请求失败或网络问题

**解决方案**：
1. 检查网络连接
2. 检查API密钥配置
3. 重新运行脚本

### 问题3：持仓未完全平掉

**原因**：市价单部分成交或被取消

**解决方案**：
1. 重新运行脚本
2. 手动查询持仓状态
3. 使用限价单手动平仓

## 相关文件

- `quick_clear_all.py` - 一键清空Python脚本
- `quick_clear_all.sh` - 一键清空Shell脚本
- `clear_accounts.py` - 原有的清空脚本（使用限价单）
- `check_b_position.py` - 查询B账户持仓
- `check_b_position_raw.py` - 查询B账户持仓（原始数据）
- `utils.py` - 工具函数（包含get_positions）

## 与原有clear_accounts.py的区别

| 特性 | quick_clear_all.py | clear_accounts.py |
|------|-------------------|-------------------|
| 平仓方式 | 市价单 | 限价单 |
| 执行速度 | 快速 | 较慢 |
| 滑点风险 | 有 | 无 |
| 成交保证 | 可能被取消 | 保证成交 |
| 适用场景 | 紧急清仓 | 正常清仓 |

## 建议

1. **正常情况**：使用 `clear_accounts.py`（限价单，更安全）
2. **紧急情况**：使用 `quick_clear_all.py`（市价单，更快速）
3. **执行前**：先查询持仓状态，确认需要清空的内容
4. **执行后**：再次查询持仓状态，确认清空成功